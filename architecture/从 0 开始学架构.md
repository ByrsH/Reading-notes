# 



# 高性能架构模式
## 20| 高性能负载均衡：分类及架构
常见的负载均衡系统包括 3 种：DNS 负载均衡、硬件负载均衡和软件负载均衡。

### DNS 负载均衡
DNS 负载均衡一般用来实现地理级别的均衡。
![image.png](https://cdn.nlark.com/yuque/0/2022/png/12431514/1652606415875-1621ca62-0b99-4377-8edb-e46305041167.png#clientId=ue89e9e1b-463a-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=509&id=u411ca98f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1018&originWidth=1224&originalType=binary&ratio=1&rotation=0&showTitle=false&size=246185&status=done&style=none&taskId=u41c37af1-10ef-4377-a030-1d06600d9c6&title=&width=612)
优点有：

- 简单、成本低：负载均衡工作交给 DNS 服务器处理，无须自己开发或者维护负载均衡设备。
- 就近访问，提升访问速度：DNS 解析时可以根据请求来源 IP，解析成距离用户最近的服务器地址，可以加快访问速度，改善性能。

缺点有：

- 更新不及时：DNS 缓存的时间比较长
- 扩展性差：DNS 负载均衡的控制权在域名商那里，无法根据业务特点针对其做更多的定制化功能和扩展特性。
- 分配策略比较简单：DNS 负载均衡支持的算法少；不能区分服务器的差异（不能根据系统与服务的状态来判断负载）；也无法感知后端服务器的状态。

### 硬件负载均衡
硬件负载均衡的优点是：

- 功能强大：全面支持各层级的负载均衡，支持全面的负载均衡算法，支持全局负载均衡。
- 性能强大：对比一下，软件负载均衡支持到 10 万级并发已经很厉害了，硬件负载均衡可以支持 100 万以上的并发。
- 稳定性高：商用硬件负载均衡，经过了良好的严格测试，经过大规模使用，稳定性高。支持安全防护：硬件均衡设备除具备负载均衡功能外，还具备防火墙、防 DDoS 攻击等安全功能。

硬件负载均衡的缺点是：

- 价格昂贵：最普通的一台 F5 就是一台“马 6”，好一点的就是“Q7”了。
- 扩展能力差：硬件设备，可以根据业务进行配置，但无法进行扩展和定制。

### 软件负载均衡
软件负载均衡通过负载均衡软件来实现负载均衡功能，常见的有 Nginx 和 LVS，其中 Nginx 是软件的 7 层负载均衡，LVS 是 Linux 内核的 4 层负载均衡。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/12431514/1652619572342-17ebe533-160c-49c4-a3f0-6b518301e7a8.png#clientId=ue89e9e1b-463a-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=357&id=ubb7c97be&margin=%5Bobject%20Object%5D&name=image.png&originHeight=714&originWidth=1114&originalType=binary&ratio=1&rotation=0&showTitle=false&size=198808&status=done&style=none&taskId=uc739eb3c-fd91-4825-8eee-fc1c32340c8&title=&width=557)

软件负载均衡的优点：

- 简单：无论是部署还是维护都比较简单。
- 便宜：只要买个 Linux 服务器，装上软件即可。
- 灵活：4 层和 7 层负载均衡可以根据业务进行选择；也可以根据业务进行比较方便的扩展，例如，可以通过 Nginx 的插件来实现业务的定制化功能。

缺点：

- 性能一般：一个 Nginx 大约能支撑 5 万并发。
- 功能没有硬件负载均衡那么强大。一般不具备防火墙和防 DDoS 攻击等安全功能。

### 负载均衡典型架构
DNS 负载均衡用于实现地理级别的负载均衡；硬件负载均衡用于实现集群级别的负载均衡；软件负载均衡用于实现机器级别的负载均衡。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/12431514/1652619811168-1d5bf61f-f960-4c7a-94b6-68f5c0978d38.png#clientId=ue89e9e1b-463a-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=394&id=u8685c208&margin=%5Bobject%20Object%5D&name=image.png&originHeight=788&originWidth=1308&originalType=binary&ratio=1&rotation=0&showTitle=false&size=441257&status=done&style=none&taskId=ue3a150cc-0cff-42f7-a49a-1740c42282a&title=&width=654)


## 21 | 高性能负载均衡：算法
负载均衡算法分类：

- 任务平分类：负载均衡系统将收到的任务平均分配给服务器进行处理，这里的“平均”可以是绝对数量的平均，也可以是比例或者权重上的平均。
- 负载均衡类：负载均衡系统根据服务器的负载来进行分配，这里的负载并不一定是通常意义上我们说的“CPU 负载”，而是系统当前的压力，可以用 CPU 负载来衡量，也可以用连接数、I/O 使用率、网卡吞吐量等来衡量系统的压力。
- 性能最优类：负载均衡系统根据服务器的响应时间来进行任务分配，优先将新任务分配给响应最快的服务器。
- Hash 类：负载均衡系统根据任务中的某些关键信息进行 Hash 运算，将相同 Hash 值的请求分配到同一台服务器上。常见的有源地址 Hash、目标地址 Hash、session id hash、用户 ID Hash 等。

### 轮询

### 加权轮询
加权轮询解决了轮询算法中无法根据服务器的配置差异进行任务分配的问题，但同样存在无法根据服务器的状态差异进行任务分配的问题。

### 负载最低优先
负载最低优先的算法解决了轮询算法中无法感知服务器状态的问题，由此带来的代价是复杂度要增加很多。

- 最少连接数优先的算法要求负载均衡系统统计每个服务器当前建立的连接。
- CPU 负载最低优先的算法要求负载均衡系统以某种方式收集每个服务器的 CPU 负载。
### 性能最优类
和负载最低优先类算法类似，性能最优优先类算法本质上也是感知了服务器的状态，只是通过响应时间这个外部标准来衡量服务器状态而已。

- 负载均衡系统需要收集和分析每个服务器每个任务的响应时间，在大量任务处理的场景下，这种收集和统计本身也会消耗较多的性能。
- 采样统计
- 采样周期，不断调优
### Hash 类
负载均衡系统根据任务中的某些关键信息进行 Hash 运算，将相同 Hash 值的请求分配到同一台服务器上。

- 源地址 Hash。
- ID Hash。






















